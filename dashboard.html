<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Broken Brownie | Command Center</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Jost:wght@300;400;600&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* --- 1. GLOBAL VARIABLES & RESET --- */
        :root {
            --bg-dark: #020617;
            --card-bg: #1e293b;
            --accent: #3b82f6; /* Tech Blue */
            --gold: #DFD0B8;   /* Brand Gold */
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --border: rgba(255, 255, 255, 0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            background-color: var(--bg-dark); 
            color: var(--text-main); 
            font-family: 'Jost', sans-serif;
            min-height: 100vh;
        }

        /* --- 2. LOGIN SCREEN (The Gate) --- */
        .login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-dark); z-index: 9999;
            display: flex; justify-content: center; align-items: center;
            background-image: radial-gradient(circle at center, #1e293b 0%, #020617 70%);
        }
        .login-box {
            text-align: center; width: 320px;
            padding: 40px; background: rgba(30, 41, 59, 0.5);
            border: 1px solid var(--border); border-radius: 16px;
            backdrop-filter: blur(10px);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }
        .login-box h2 { font-weight: 300; letter-spacing: 2px; margin-bottom: 20px; color: var(--gold); }
        .login-input {
            width: 100%; padding: 12px; margin-bottom: 15px;
            background: #0f172a; border: 1px solid var(--border);
            color: white; border-radius: 8px; outline: none; text-align: center;
            transition: 0.3s;
        }
        .login-input:focus { border-color: var(--accent); }
        .login-btn {
            width: 100%; padding: 12px; background: var(--accent);
            color: white; border: none; border-radius: 8px; font-weight: 600;
            cursor: pointer; transition: 0.3s;
        }
        .login-btn:hover { background: #2563eb; box-shadow: 0 0 15px rgba(59, 130, 246, 0.5); }

        /* --- 3. DASHBOARD LAYOUT --- */
        .dashboard-container { display: none; padding: 40px; max-width: 1400px; margin: 0 auto; }
        
        /* Header */
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px; }
        .brand-area h1 { font-size: 1.8rem; font-weight: 600; letter-spacing: 1px; }
        .brand-area span { color: var(--gold); }
        .status-badge { 
            background: rgba(34, 197, 94, 0.1); color: #22c55e; 
            padding: 6px 15px; border-radius: 20px; font-size: 0.85rem; font-weight: 600;
            display: flex; align-items: center; gap: 8px; border: 1px solid rgba(34, 197, 94, 0.2);
        }
        .pulse { width: 8px; height: 8px; background: #22c55e; border-radius: 50%; box-shadow: 0 0 10px #22c55e; animation: pulse 2s infinite; }

        /* KPI Grid */
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .kpi-card {
            background: var(--card-bg); padding: 25px; border-radius: 12px;
            border: 1px solid var(--border); position: relative; overflow: hidden;
        }
        .kpi-label { color: var(--text-muted); font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px; display: block; }
        .kpi-value { font-size: 2.5rem; font-weight: 600; color: white; }
        .kpi-sub { font-size: 0.8rem; color: var(--accent); margin-top: 5px; display: block; }
        .kpi-card::after {
            content: ''; position: absolute; top: 0; right: 0; width: 100px; height: 100px;
            background: radial-gradient(circle, rgba(59, 130, 246, 0.1) 0%, transparent 70%);
        }

        /* Charts Section */
        .charts-row { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 30px; }
        .chart-box {
            background: var(--card-bg); padding: 25px; border-radius: 12px;
            border: 1px solid var(--border); height: 350px;
        }

        /* Recent Activity Table */
        .table-box { background: var(--card-bg); border-radius: 12px; border: 1px solid var(--border); overflow: hidden; }
        .table-header { padding: 20px 25px; border-bottom: 1px solid var(--border); font-weight: 600; color: var(--gold); }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 15px 25px; background: rgba(0,0,0,0.2); color: var(--text-muted); font-weight: 500; font-size: 0.9rem; }
        td { padding: 15px 25px; border-bottom: 1px solid var(--border); font-size: 0.95rem; }
        tr:last-child td { border-bottom: none; }
        tr:hover { background: rgba(255,255,255,0.02); }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        @media (max-width: 1024px) {
            .charts-row { grid-template-columns: 1fr; height: auto; }
            .chart-box { height: 300px; }
        }
    </style>
</head>
<body>

    <div id="login-overlay" class="login-overlay">
        <div class="login-box">
            <h2>OWNER ACCESS</h2>
            <input type="password" id="admin-pass" class="login-input" placeholder="Enter Passcode">
            <button onclick="login()" class="login-btn">Initialize System</button>
            <p id="login-msg" style="margin-top: 15px; font-size: 0.8rem; color: #ef4444; display: none;"></p>
        </div>
    </div>

    <div id="dashboard" class="dashboard-container">
        
        <header>
            <div class="brand-area">
                <h1>Broken Brownie <span>Analytics</span></h1>
                <small style="color: var(--text-muted);">Real-time Visitor Insights</small>
            </div>
            <div class="status-badge">
                <div class="pulse"></div> SYSTEM LIVE
                <button onclick="location.reload()" style="background:none; border:none; color:#ef4444; cursor:pointer; margin-left:15px; font-weight:bold;">LOGOUT</button>
            </div>
        </header>

        <div class="kpi-grid">
            <div class="kpi-card">
                <span class="kpi-label">Total Traffic</span>
                <span class="kpi-value" id="val-total">0</span>
                <span class="kpi-sub">All-time hits</span>
            </div>
            <div class="kpi-card">
                <span class="kpi-label">Top Location</span>
                <span class="kpi-value" id="val-city" style="font-size: 1.8rem;">--</span>
                <span class="kpi-sub" id="val-country">Waiting for data...</span>
            </div>
            <div class="kpi-card">
                <span class="kpi-label">Peak Activity</span>
                <span class="kpi-value" id="val-peak">--</span>
                <span class="kpi-sub">Most active hour</span>
            </div>
            <div class="kpi-card">
                <span class="kpi-label">Mobile Users</span>
                <span class="kpi-value" id="val-mobile">0%</span>
                <span class="kpi-sub" id="val-desktop">0% Desktop</span>
            </div>
        </div>

        <div class="charts-row">
            <div class="chart-box">
                <h3 style="margin-bottom: 20px; font-weight: 400; color: var(--text-muted);">Visitor Trend (Last 50 Hits)</h3>
                <canvas id="trendChart"></canvas>
            </div>
            <div class="chart-box">
                <h3 style="margin-bottom: 20px; font-weight: 400; color: var(--text-muted);">Device Breakdown</h3>
                <canvas id="deviceChart"></canvas>
            </div>
        </div>

        <div class="table-box">
            <div class="table-header">Raw Access Logs (Live)</div>
            <table>
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Origin</th>
                        <th>Device</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="table-body">
                    </tbody>
            </table>
        </div>

    </div>

    <script>
        // --- CONFIGURATION ---
        // Switch this URL when you deploy!
        // Localhost: 'http://localhost:5000/api/admin/stats'
        // Render: 'https://broken-brownie-api.onrender.com/api/admin/stats'
       const API_URL = 'http://localhost:5000/api/admin/stats';

        // --- LOGIN LOGIC ---
        async function login() {
            const pass = document.getElementById('admin-pass').value;
            const btn = document.querySelector('.login-btn');
            const msg = document.getElementById('login-msg');

            btn.innerText = "Authenticating...";
            msg.style.display = 'none';

            try {
                const res = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password: pass })
                });

                if (res.status === 200) {
                    const data = await res.json();
                    document.getElementById('login-overlay').style.display = 'none';
                    document.getElementById('dashboard').style.display = 'block';
                    processAndRender(data);
                } else {
                    throw new Error("Invalid Password");
                }
            } catch (err) {
                btn.innerText = "Initialize System";
                msg.innerText = "Error: " + (err.message || "Server Offline");
                msg.style.display = 'block';
            }
        }

        // --- DATA PROCESSING & RENDERING ---
        function processAndRender(data) {
            // 1. Basic Stats
            document.getElementById('val-total').innerText = data.total;
            
            // Calculate Mobile %
            const mobPercent = Math.round((data.mobile / data.total) * 100) || 0;
            document.getElementById('val-mobile').innerText = mobPercent + "%";
            document.getElementById('val-desktop').innerText = (100 - mobPercent) + "% Desktop";

            // 2. Derive Top Location (Client-side math)
            const cities = {};
            data.recent.forEach(v => {
                const loc = v.city === 'Unknown' ? 'Localhost' : v.city;
                cities[loc] = (cities[loc] || 0) + 1;
            });
            const topCity = Object.keys(cities).reduce((a, b) => cities[a] > cities[b] ? a : b, "--");
            document.getElementById('val-city').innerText = topCity;
            
            // Find Country for top city
            const topRecord = data.recent.find(r => r.city === topCity);
            document.getElementById('val-country').innerText = topRecord ? topRecord.country : "N/A";

            // 3. Derive Peak Hour
            const hours = {};
            data.recent.forEach(v => {
                const h = new Date(v.timestamp).getHours();
                hours[h] = (hours[h] || 0) + 1;
            });
            const peakH = Object.keys(hours).reduce((a, b) => hours[a] > hours[b] ? a : b, 12);
            const ampm = peakH >= 12 ? 'PM' : 'AM';
            const displayH = peakH % 12 || 12; 
            document.getElementById('val-peak').innerText = `${displayH} ${ampm}`;

            // 4. Render Table
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '';
            data.recent.slice(0, 10).forEach(visit => {
                const time = new Date(visit.timestamp).toLocaleTimeString();
                const loc = visit.city === 'Unknown' ? 'Localhost / Unknown' : `${visit.city}, ${visit.country}`;
                
                const row = `<tr>
                    <td style="color:var(--accent);">${time}</td>
                    <td>${loc}</td>
                    <td>${visit.device}</td>
                    <td><span style="color:#22c55e;">‚óè Verified</span></td>
                </tr>`;
                tbody.innerHTML += row;
            });

            // 5. Render Charts (Chart.js)
            renderCharts(data);
        }

        function renderCharts(data) {
            // A. Device Doughnut
            new Chart(document.getElementById('deviceChart'), {
                type: 'doughnut',
                data: {
                    labels: ['Mobile', 'Desktop'],
                    datasets: [{
                        data: [data.mobile, data.desktop],
                        backgroundColor: ['#3b82f6', '#DFD0B8'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom', labels: { color: '#94a3b8' } } }
                }
            });

            // B. Trend Line (Mocking time buckets for visual)
            const recentVisits = data.recent.slice(0, 20).reverse(); // Last 20
            const labels = recentVisits.map(v => new Date(v.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}));
            // Just for visual trend, we map simply 1s as events. 
            // In a real advanced app, we'd bucket by hour.
            const points = recentVisits.map(() => 1); 

            new Chart(document.getElementById('trendChart'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Hits',
                        data: points.map((_, i) => i + Math.random() * 2), // Simulated 'Cumulative' feel for visual
                        borderColor: '#22c55e',
                        backgroundColor: 'rgba(34, 197, 94, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { ticks: { color: '#94a3b8' }, grid: { color: 'rgba(255,255,255,0.05)' } },
                        y: { display: false }
                    }
                }
            });
        }
    </script>
</body>
</html>