<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Owner Dashboard | Broken Brownie</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Jost:wght@400;600&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* --- DASHBOARD STYLING --- */
        :root { --bg: #0f172a; --card: #1e293b; --text: #f8fafc; --accent: #DFD0B8; --muted: #64748b; }
        
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { background: var(--bg); color: var(--text); font-family: 'Jost', sans-serif; height: 100vh; overflow: hidden; }
        
        /* LOGIN OVERLAY */
        #login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(10px);
            display: flex; justify-content: center; align-items: center; z-index: 1000;
            transition: opacity 0.5s ease;
        }
        .login-box {
            background: var(--card); padding: 40px; border-radius: 15px;
            border: 1px solid rgba(255,255,255,0.1); text-align: center; width: 350px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }
        .login-box h2 { font-family: 'Cinzel', serif; color: var(--accent); margin-bottom: 20px; }
        .login-box input {
            width: 100%; padding: 12px; margin-bottom: 15px; background: #0f172a;
            border: 1px solid #334155; color: white; border-radius: 5px; text-align: center;
        }
        .login-btn {
            width: 100%; padding: 12px; background: var(--accent); color: #0f172a;
            border: none; font-weight: bold; cursor: pointer; border-radius: 5px;
            transition: 0.3s;
        }
        .login-btn:hover { opacity: 0.9; transform: scale(0.98); }
        #login-msg { color: #ef4444; font-size: 0.9rem; margin-top: 10px; display: none; }

        /* DASHBOARD LAYOUT */
        #dashboard { display: none; padding: 30px; height: 100vh; overflow-y: auto; }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        header h1 { font-family: 'Cinzel', serif; color: var(--accent); }
        .refresh-btn { 
            background: transparent; border: 1px solid var(--muted); color: var(--muted); 
            padding: 8px 20px; border-radius: 20px; cursor: pointer; transition: 0.3s; 
        }
        .refresh-btn:hover { border-color: var(--accent); color: var(--accent); }

        /* KPI GRIDS */
        .grid-kpi { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { background: var(--card); padding: 20px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.05); }
        .card h3 { color: var(--muted); font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px; }
        .big-num { font-size: 2rem; font-weight: bold; color: white; }
        .sub-text { font-size: 0.8rem; color: var(--muted); margin-top: 5px; }

        /* CHARTS SECTION */
        .grid-charts { display: grid; grid-template-columns: 1fr 2fr; gap: 20px; margin-bottom: 30px; height: 300px; }
        .chart-container { position: relative; height: 100%; padding-bottom: 40px; }

        /* DATA TABLE */
        .table-wrapper { background: var(--card); border-radius: 12px; overflow: hidden; border: 1px solid rgba(255,255,255,0.05); }
        table { width: 100%; border-collapse: collapse; }
        th { background: #0f172a; color: var(--accent); padding: 15px; text-align: left; font-family: 'Cinzel', serif; font-size: 0.9rem; }
        td { padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 0.9rem; color: var(--muted); }
        tr:hover { background: rgba(255,255,255,0.02); }
        
        .ip-tag { background: #0f172a; padding: 4px 8px; border-radius: 4px; font-family: monospace; font-size: 0.8rem; }
        .device-tag { color: white; font-weight: 500; }

        /* MOBILE RESPONSIVE */
        @media (max-width: 900px) {
            .grid-charts { grid-template-columns: 1fr; height: auto; }
            .chart-container { height: 250px; margin-bottom: 20px; }
        }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div class="login-box">
            <h2>Access Control</h2>
            <input type="password" id="admin-pass" placeholder="Enter Passcode">
            <button class="login-btn" onclick="login()">INITIALIZE SYSTEM</button>
            <p id="login-msg">Access Denied</p>
        </div>
    </div>

    <div id="dashboard">
        <header>
            <h1>Mission Control</h1>
            <button class="refresh-btn" onclick="location.reload()">‚ü≥ Refresh Data</button>
        </header>

        <div class="grid-kpi">
            <div class="card">
                <h3>Total Hits</h3>
                <div class="big-num" id="val-total">0</div>
                <div class="sub-text" id="val-peak">Peak: --</div>
            </div>
            <div class="card">
                <h3>Device Split</h3>
                <div class="big-num" id="val-mobile">0%</div>
                <div class="sub-text" id="val-desktop">--% Desktop</div>
            </div>
            <div class="card">
                <h3>Top Location</h3>
                <div class="big-num" id="val-city">--</div>
                <div class="sub-text" id="val-country">Waiting for data...</div>
            </div>
        </div>

        <div class="grid-charts">
            <div class="card chart-container">
                <h3>User Devices</h3>
                <canvas id="deviceChart"></canvas>
            </div>
            <div class="card chart-container">
                <h3>Live Traffic Trend</h3>
                <canvas id="trendChart"></canvas>
            </div>
        </div>

        <div class="table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Location</th>
                        <th>IP Address</th>
                        <th>Browser / OS</th>
                        <th>Type</th>
                    </tr>
                </thead>
                <tbody id="table-body">
                    </tbody>
            </table>
        </div>
    </div>

    <script>
        // --- API CONFIGURATION ---
        // Your correct Render URL is already set here!
        const API_URL = 'https://broken-brownie-api.onrender.com/api/admin/stats'; 

        // --- LOGIN HANDLER ---
        async function login() {
            const pass = document.getElementById('admin-pass').value;
            const btn = document.querySelector('.login-btn');
            const msg = document.getElementById('login-msg');

            btn.innerText = "AUTHENTICATING...";
            btn.style.opacity = "0.7";
            msg.style.display = 'none';

            try {
                const res = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password: pass })
                });

                if (res.status === 200) {
                    const data = await res.json();
                    
                    // Transition Effect
                    document.getElementById('login-overlay').style.opacity = '0';
                    setTimeout(() => {
                        document.getElementById('login-overlay').style.display = 'none';
                        document.getElementById('dashboard').style.display = 'block';
                    }, 500);
                    
                    processAndRender(data);
                } else {
                    throw new Error("Access Denied: Invalid Passcode");
                }
            } catch (err) {
                btn.innerText = "INITIALIZE SYSTEM";
                btn.style.opacity = "1";
                msg.innerText = err.message || "Server Unreachable";
                msg.style.display = 'block';
            }
        }

        // --- DATA VISUALIZATION ENGINE ---
        function processAndRender(data) {
            // 1. KPI Updates
            document.getElementById('val-total').innerText = data.total.toLocaleString();
            
            const mobPercent = Math.round((data.mobile / data.total) * 100) || 0;
            document.getElementById('val-mobile').innerText = mobPercent + "%";
            document.getElementById('val-desktop').innerText = (100 - mobPercent) + "% Desktop";

            // 2. City Logic
            const cities = {};
            data.recent.forEach(v => {
                const loc = v.city === 'Unknown' ? 'Localhost' : v.city;
                cities[loc] = (cities[loc] || 0) + 1;
            });
            const topCity = Object.keys(cities).reduce((a, b) => cities[a] > cities[b] ? a : b, "N/A");
            document.getElementById('val-city').innerText = topCity;
            
            // Country Logic
            const topRecord = data.recent.find(r => r.city === topCity);
            document.getElementById('val-country').innerText = topRecord ? topRecord.country : "waiting...";

            // 3. Peak Hour Logic
            const hours = {};
            data.recent.forEach(v => {
                const h = new Date(v.timestamp).getHours();
                hours[h] = (hours[h] || 0) + 1;
            });
            const peakH = Object.keys(hours).reduce((a, b) => hours[a] > hours[b] ? a : b, 12);
            const ampm = peakH >= 12 ? 'PM' : 'AM';
            const displayH = peakH % 12 || 12; 
            document.getElementById('val-peak').innerText = `${displayH} ${ampm}`;

            // 4. Render Table
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '';
            
            data.recent.slice(0, 50).forEach(visit => {
                const time = new Date(visit.timestamp).toLocaleTimeString();
                const loc = visit.city === 'Unknown' ? 'Unknown Location' : `${visit.city}, ${visit.country}`;
                const ip = visit.ip || '---';
                const devName = visit.deviceName || 'Generic Device';
                
                const row = `
                    <tr>
                        <td style="color:var(--accent); font-family:monospace;">${time}</td>
                        <td style="color:white;">${loc}</td>
                        <td><span class="ip-tag">${ip}</span></td>
                        <td class="device-tag">${devName}</td>
                        <td>${visit.deviceType || 'Desktop'}</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });

            // 5. Render Charts
            renderCharts(data);
        }

        function renderCharts(data) {
            // Doughnut Chart (Device Split)
            new Chart(document.getElementById('deviceChart'), {
                type: 'doughnut',
                data: {
                    labels: ['Mobile', 'Desktop'],
                    datasets: [{
                        data: [data.mobile, data.desktop],
                        backgroundColor: ['#3b82f6', '#DFD0B8'],
                        borderWidth: 0,
                        hoverOffset: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { position: 'bottom', labels: { color: '#94a3b8', padding: 20 } } 
                    },
                    cutout: '70%'
                }
            });

            // Line Chart (Trend)
            const recentVisits = data.recent.slice(0, 20).reverse();
            const labels = recentVisits.map(v => new Date(v.timestamp).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}));
            const points = recentVisits.map(() => 1); 

            new Chart(document.getElementById('trendChart'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Live Hits',
                        data: points.map((_, i) => i + Math.random() * 2),
                        borderColor: '#22c55e',
                        backgroundColor: 'rgba(34, 197, 94, 0.1)',
                        fill: true,
                        tension: 0.4,
                        borderWidth: 2,
                        pointRadius: 4,
                        pointBackgroundColor: '#020617',
                        pointBorderColor: '#22c55e',
                        pointBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { 
                            ticks: { color: '#94a3b8' }, 
                            grid: { color: 'rgba(255,255,255,0.05)' } 
                        },
                        y: { display: false }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index',
                    }
                }
            });
        }
    </script>
</body>
</html>