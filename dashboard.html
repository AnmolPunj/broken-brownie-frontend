<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Owner Dashboard | Broken Brownie</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Jost:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root { --bg: #0f172a; --card: #1e293b; --text: #f8fafc; --accent: #DFD0B8; --muted: #64748b; }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { background: var(--bg); color: var(--text); font-family: 'Jost', sans-serif; height: 100vh; overflow: hidden; }
        
        /* LOGIN & LAYOUT */
        #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15,23,42,0.95); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .login-box { background: var(--card); padding: 40px; border-radius: 15px; width: 350px; text-align: center; border: 1px solid rgba(255,255,255,0.1); }
        .login-box input { width: 100%; padding: 12px; margin-bottom: 15px; background: #0f172a; border: 1px solid #334155; color: white; border-radius: 5px; text-align: center; }
        .login-btn { width: 100%; padding: 12px; background: var(--accent); border: none; font-weight: bold; cursor: pointer; border-radius: 5px; }
        
        #dashboard { display: none; padding: 30px; height: 100vh; overflow-y: auto; }
        
        /* TABS (New!) */
        .tab-menu { display: flex; gap: 20px; margin-bottom: 30px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px; }
        .tab-btn { background: none; border: none; color: var(--muted); font-size: 1.1rem; cursor: pointer; padding: 10px; font-family: 'Cinzel', serif; }
        .tab-btn.active { color: var(--accent); border-bottom: 2px solid var(--accent); }
        
        .section { display: none; }
        .section.active { display: block; }

        /* ANALYTICS STYLES */
        .grid-kpi { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { background: var(--card); padding: 20px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.05); }
        .big-num { font-size: 2rem; font-weight: bold; }
        .grid-charts { display: grid; grid-template-columns: 1fr 2fr; gap: 20px; height: 300px; margin-bottom: 30px; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #0f172a; color: var(--accent); padding: 15px; text-align: left; }
        td { padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.05); color: var(--muted); }

        /* ADD MENU ITEM STYLES (New!) */
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .form-group { margin-bottom: 20px; }
        label { display: block; color: var(--accent); margin-bottom: 8px; font-size: 0.9rem; }
        input, textarea { width: 100%; padding: 12px; background: #0f172a; border: 1px solid #334155; color: white; border-radius: 8px; }
        .upload-box { border: 2px dashed #334155; padding: 30px; text-align: center; border-radius: 8px; cursor: pointer; transition: 0.3s; }
        .upload-box:hover { border-color: var(--accent); }
        .save-btn { background: var(--accent); color: #0f172a; border: none; padding: 15px 40px; font-weight: bold; border-radius: 50px; cursor: pointer; font-size: 1rem; margin-top: 20px; }

        @media (max-width: 900px) { .grid-charts, .form-grid { grid-template-columns: 1fr; height: auto; } }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div class="login-box">
            <h2 style="color:var(--accent); margin-bottom:20px;">Access Control</h2>
            <input type="password" id="admin-pass" placeholder="Enter Passcode">
            <button class="login-btn" onclick="login()">INITIALIZE SYSTEM</button>
            <p id="login-msg" style="color:red; display:none; margin-top:10px;">Access Denied</p>
        </div>
    </div>

    <div id="dashboard">
        <header style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px;">
            <h1 style="font-family:'Cinzel', serif; color:var(--accent);">Mission Control</h1>
            <button onclick="location.reload()" style="background:none; border:1px solid var(--muted); color:var(--muted); padding:8px 20px; border-radius:20px; cursor:pointer;">⟳ Refresh</button>
        </header>

        <div class="tab-menu">
            <button class="tab-btn active" onclick="switchTab('analytics')">ANALYTICS</button>
            <button class="tab-btn" onclick="switchTab('menu')">MENU MANAGER</button>
        </div>

        <div id="analytics" class="section active">
            <div class="grid-kpi">
                <div class="card"><h3>Total Hits</h3><div class="big-num" id="val-total">0</div></div>
                <div class="card"><h3>Device Split</h3><div class="big-num" id="val-mobile">0%</div><div style="font-size:0.8rem; color:var(--muted);" id="val-desktop">--% Desktop</div></div>
                <div class="card"><h3>Top Location</h3><div class="big-num" id="val-city">--</div></div>
            </div>
            <div class="grid-charts">
                <div class="card"><canvas id="deviceChart"></canvas></div>
                <div class="card"><canvas id="trendChart"></canvas></div>
            </div>
            <div class="card">
                <table>
                    <thead><tr><th>Time</th><th>Location</th><th>IP</th><th>Device</th></tr></thead>
                    <tbody id="table-body"></tbody>
                </table>
            </div>
        </div>

        <div id="menu" class="section">
            <div class="card">
                <h2 style="color:var(--accent); margin-bottom:20px;">Add New Brownie</h2>
                <div class="form-grid">
                    <div>
                        <div class="form-group">
                            <label>Brownie Name</label>
                            <input type="text" id="prod-name" placeholder="e.g. Red Velvet Crinkle">
                        </div>
                        <div class="form-group">
                            <label>Price (₹)</label>
                            <input type="number" id="prod-price" placeholder="149">
                        </div>
                        <div class="form-group">
                            <label>Description</label>
                            <textarea id="prod-desc" rows="4" placeholder="Rich cocoa with a hint of..."></textarea>
                        </div>
                    </div>
                    <div>
                        <div class="form-group">
                            <label>Product Image</label>
                            <div class="upload-box" onclick="document.getElementById('prod-img').click()">
                                <p style="color:var(--muted);">Click to Upload Image</p>
                                <input type="file" id="prod-img" hidden accept="image/*">
                                <img id="img-preview" src="" style="max-width:100%; margin-top:10px; border-radius:8px; display:none;">
                            </div>
                            <p style="font-size:0.8rem; color:var(--muted); margin-top:5px;">Max size: 50MB</p>
                        </div>
                    </div>
                </div>
                <button class="save-btn" onclick="addNewItem()">PUBLISH ITEM</button>
            </div>
        </div>
    </div>

    <script>
        // --- API CONFIGURATION ---
        const API_URL = 'https://broken-brownie-api.onrender.com';

        // --- TABS LOGIC ---
        function switchTab(tabName) {
            document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        // --- LOGIN ---
        async function login() {
            const pass = document.getElementById('admin-pass').value;
            const btn = document.querySelector('.login-btn');
            btn.innerText = "AUTHENTICATING...";
            
            try {
                const res = await fetch(`${API_URL}/api/admin/stats`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password: pass })
                });

                if (res.status === 200) {
                    const data = await res.json();
                    document.getElementById('login-overlay').style.display = 'none';
                    document.getElementById('dashboard').style.display = 'block';
                    renderAnalytics(data);
                } else {
                    throw new Error();
                }
            } catch (err) {
                btn.innerText = "TRY AGAIN";
                document.getElementById('login-msg').style.display = 'block';
            }
        }

        // --- ANALYTICS ENGINE ---
        function renderAnalytics(data) {
            document.getElementById('val-total').innerText = data.total.toLocaleString();
            const mob = Math.round((data.mobile/data.total)*100)||0;
            document.getElementById('val-mobile').innerText = mob + "%";
            document.getElementById('val-desktop').innerText = (100-mob) + "% Desktop";
            
            // Charts
            new Chart(document.getElementById('deviceChart'), {
                type: 'doughnut',
                data: { labels: ['Mobile','Desktop'], datasets: [{ data: [data.mobile, data.desktop], backgroundColor:['#3b82f6','#DFD0B8'], borderWidth:0 }] },
                options: { cutout: '70%', plugins: { legend: { position:'bottom', labels:{color:'#94a3b8'} } } }
            });

            // Table
            const tbody = document.getElementById('table-body');
            data.recent.slice(0,10).forEach(v => {
                tbody.innerHTML += `<tr>
                    <td style="color:var(--accent);">${new Date(v.timestamp).toLocaleTimeString()}</td>
                    <td>${v.city||'Unknown'}</td>
                    <td>${v.ip||'--'}</td>
                    <td>${v.deviceName||'Generic'}</td>
                </tr>`;
            });
        }

        // --- IMAGE PREVIEW LOGIC ---
        document.getElementById('prod-img').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if(file){
                const reader = new FileReader();
                reader.onload = function(ev) {
                    const img = document.getElementById('img-preview');
                    img.src = ev.target.result;
                    img.style.display = 'block';
                }
                reader.readAsDataURL(file);
            }
        });

        // --- ADD NEW ITEM (THE FIX) ---
        async function addNewItem() {
            const name = document.getElementById('prod-name').value;
            const price = document.getElementById('prod-price').value;
            const desc = document.getElementById('prod-desc').value;
            const fileInput = document.getElementById('prod-img');
            const btn = document.querySelector('.save-btn');

            if (!name || !price || !fileInput.files[0]) {
                alert("Please fill all fields and select an image!");
                return;
            }

            btn.innerText = "UPLOADING...";
            btn.style.opacity = "0.7";

            // 1. Convert Image to Base64
            const reader = new FileReader();
            reader.readAsDataURL(fileInput.files[0]);
            
            reader.onloadend = async function() {
                const base64Image = reader.result;

                // 2. Send to Server
                try {
                    const res = await fetch(`${API_URL}/api/products`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            name: name,
                            price: price,
                            description: desc,
                            image: base64Image // This is the big file string
                        })
                    });

                    if (res.ok) {
                        alert("✅ Item Added Successfully!");
                        location.reload();
                    } else {
                        alert("❌ Server Error. Try again.");
                    }
                } catch (err) {
                    alert("❌ Connection Failed. Check internet.");
                }
                btn.innerText = "PUBLISH ITEM";
                btn.style.opacity = "1";
            };
        }
    </script>
</body>
</html>